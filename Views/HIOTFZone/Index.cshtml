@model IEnumerable<MXH_HIOTFZone.Models.BaiDang>
@{
    ViewBag.Title = "Bảng tin";
    Layout = "~/Views/Shared/HIOTFZone_Layout.cshtml";

    string currentAvatar = "/Images/Avatar/default.png";
    if (Session["Avatar"] != null)
    {
        currentAvatar = "/Images/Avatar/" + Session["Avatar"].ToString();
    }
    int currentUserId = Session["NguoiDungID"] != null ? (int)Session["NguoiDungID"] : 0;
}

<div class="col-lg-6 mx-auto" style="padding-top:60px">

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body d-flex gap-2">
            <img src="@currentAvatar" class="avatar rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
            <div class="flex-grow-1">
                <a href="@Url.Action("TaoBaiViet","HIOTFZone_BaiViet")" class="btn btn-light w-100 text-start text-muted rounded-pill">
                    Bạn đang nghĩ gì thế?
                </a>
            </div>
        </div>
    </div>

    <div id="feed">
        @foreach (var baiviet in Model)
        {
            string anhBaiViet = "/Images/BaiViet/" + baiviet.AnhUrl;
            string anhAvatar = "/Images/Avatar/" + (baiviet.NguoiDung.Avatar ?? "default.png");
            bool daLike = baiviet.ThichBaiDangs.Any(x => x.NguoiDungID == currentUserId);

            <div class="card p-3 mb-4 shadow-sm border-0 post-card" data-baidangid="@baiviet.BaiDangID">

                <div class="d-flex align-items-center gap-2 mb-3">
                    <img src="@anhAvatar" class="avatar rounded-circle" style="width:40px; height:40px; object-fit:cover;" />
                    <div>
                        <h6 class="m-0 fw-bold">@baiviet.NguoiDung.TenNguoiDung</h6>
                        <small class="text-muted" style="font-size: 12px;">@baiviet.NgayTao</small>
                    </div>
                </div>

                <p class="card-text mb-2">@baiviet.NoiDung</p>
                @if (!string.IsNullOrEmpty(baiviet.AnhUrl))
                {
                    <div class="mb-3">
                        <img src="@anhBaiViet" class="img-fluid rounded w-100" style="object-fit: cover; max-height: 500px;" />
                    </div>
                }

                <div class="border-top border-bottom py-2 d-flex justify-content-between mt-2">
                    <button class="btn btn-light flex-grow-1 btn-like @(daLike ? "text-primary" : "")" style="border:none;">
                        <i class="@(daLike ? "fa-solid" : "fa-regular") fa-thumbs-up me-1"></i>
                        Thích (<span class="like-count">@baiviet.ThichBaiDangs.Count()</span>)
                    </button>

                    <button class="btn btn-light flex-grow-1 btn-toggle-comment" style="border:none;">
                        <i class="fa-regular fa-comment me-1"></i> Bình luận
                    </button>
                </div>

                <div class="comment-section mt-3" style="display:none;">
                    <div class="comment-list mb-3">
                        @if (baiviet.BinhLuans != null)
                        {
                            foreach (var bl in baiviet.BinhLuans.OrderBy(b => b.NgayTao))
                            {
                                string blAvatar = "/Images/Avatar/" + (bl.NguoiDung.Avatar ?? "default.png");
                                <div class="d-flex mb-2 align-items-start">
                                    <img src="@blAvatar" class="avatar rounded-circle" style="width:40px; height:40px; object-fit:cover;" />

                                    <div class="bg-light px-3 py-2 rounded-4">
                                        <strong class="d-block text-dark" style="font-size: 13px;">@bl.NguoiDung.TenNguoiDung</strong>
                                        <span class="text-secondary" style="font-size: 13px;">@bl.NoiDung</span>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <img src="@currentAvatar" class="avatar rounded-circle" style="width:40px; height:40px; object-fit:cover;" />

                        <div class="position-relative w-100">
                            <input type="text" class="form-control rounded-pill bg-light comment-input py-1 px-3"
                                   style="font-size: 14px;"
                                   placeholder="Viết bình luận..."
                                   data-id="@baiviet.BaiDangID">
                            <i class="fa-solid fa-paper-plane position-absolute top-50 end-0 translate-middle-y me-3 text-muted btn-send-comment"
                               style="cursor:pointer; font-size: 14px;"></i>
                        </div>
                    </div>
                </div>

            </div>
        }
    </div>
</div>

@section scripts {
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="/signalr/hubs"></script>
    <script>
        $(function () {
            // --- SIGNALR SETUP ---
            var hub = $.connection.hIOTFZone_BaiDangHub;

            // 1. Nhận Like realtime
            hub.client.updateLike = function (baiDangId, likeCount) {
                var post = $('.post-card[data-baidangid="' + baiDangId + '"]');
                post.find('.like-count').text(likeCount);
            };

            // 2. Nhận Comment realtime (Thêm mới vào danh sách)
            // Tìm đoạn hub.client.addNewComment trong thẻ <script>
            hub.client.addNewComment = function (baiDangId, tenUser, avatarUrl, noiDung) {
                var post = $('.post-card[data-baidangid="' + baiDangId + '"]');
                var commentList = post.find('.comment-list');

                var newCommentHtml = `
<div class="d-flex mb-2 align-items-start">
                <img src="${avatarUrl}" class="avatar rounded-circle me-2"
                     style="width:40px; height:40px; object-fit:cover; flex-shrink: 0;">

                <div class="bg-light px-3 py-2 rounded-4">
                    <strong class="d-block text-dark" style="font-size: 13px;">${tenUser}</strong>
                    <span class="text-secondary" style="font-size: 13px;">${noiDung}</span>
                </div>
            </div>
        `;

                commentList.append(newCommentHtml);
            };

            $.connection.hub.start();


            // --- XỬ LÝ SỰ KIỆN CLICK/ENTER ---

            // A. Toggle ẩn hiện khung bình luận
            $(document).on('click', '.btn-toggle-comment', function () {
                var post = $(this).closest('.post-card');
                post.find('.comment-section').slideToggle(); // Hiệu ứng trượt

                // Focus vào ô input khi mở
                setTimeout(function () {
                    post.find('.comment-input').focus();
                }, 400);
            });

            // B. Gửi bình luận khi nhấn Enter
            $(document).on('keypress', '.comment-input', function (e) {
                if (e.which == 13) { // Mã phím Enter
                    var input = $(this);
                    var baiDangId = input.data('id');
                    var noiDung = input.val();

                    sendComment(baiDangId, noiDung, input);
                }
            });

            // C. Gửi bình luận khi nhấn nút mũi tên
            $(document).on('click', '.btn-send-comment', function () {
                var icon = $(this);
                var input = icon.siblings('.comment-input');
                var baiDangId = input.data('id');
                var noiDung = input.val();

                sendComment(baiDangId, noiDung, input);
            });

            // Hàm gửi Ajax
            function sendComment(baiDangId, noiDung, inputElement) {
                if (!noiDung.trim()) return;

                $.ajax({
                    url: '/HIOTFZone_BaiViet/GuiBinhLuan',
                    type: 'POST',
                    data: { baiDangId: baiDangId, noiDung: noiDung },
                    success: function (res) {
                        if (res.success) {
                            inputElement.val(''); // Xóa ô nhập sau khi gửi thành công
                            // Không cần append thủ công ở đây vì SignalR (client.addNewComment) sẽ làm việc đó
                        } else {
                            alert(res.message);
                        }
                    },
                    error: function () {
                        alert("Lỗi khi gửi bình luận.");
                    }
                });
            }

            // D. Xử lý Like
            $(document).on('click', '.btn-like', function () {
                var btn = $(this);
                var postDiv = btn.closest('.post-card');
                var baiDangId = postDiv.data('baidangid');

                // Optimistic UI update
                var icon = btn.find('i');
                if (icon.hasClass('fa-regular')) {
                    icon.removeClass('fa-regular').addClass('fa-solid text-primary');
                    btn.addClass('text-primary');
                } else {
                    icon.removeClass('fa-solid text-primary').addClass('fa-regular');
                    btn.removeClass('text-primary');
                }

                $.post('/HIOTFZone_BaiViet/ToggleLike', { baiDangId: baiDangId }, function (res) {
                    if (res.success) {
                        btn.find('.like-count').text(res.likeCount);
                        // Cập nhật lại chính xác từ server
                        btn.find('i').toggleClass('fa-regular fa-solid text-primary', res.liked);
                        btn.find('i').toggleClass('fa-regular', !res.liked);
                    } else {
                        alert(res.message);
                    }
                });
            });
        });
    </script>
}