@model MXH_HIOTFZone.Models.BaiDang
@{
    ViewBag.Title = "Chi tiết bài viết";
    Layout = "~/Views/Shared/HIOTFZone_Layout.cshtml";

    // 1. Lấy thông tin người dùng hiện tại (để hiển thị avatar ở ô nhập)
    string currentAvatar = "/Images/Avatar/default.png";
    if (Session["Avatar"] != null)
    {
        currentAvatar = "/Images/Avatar/" + Session["Avatar"].ToString();
    }
    int currentUserId = Session["NguoiDungID"] != null ? (int)Session["NguoiDungID"] : 0;

    // 2. Thông tin bài viết
    string anhBaiViet = "/Images/BaiViet/" + Model.AnhUrl;
    string anhAvatar = "/Images/Avatar/" + (Model.NguoiDung.Avatar ?? "default.png");

    // 3. Check like
    bool daLike = Model.ThichBaiDangs.Any(x => x.NguoiDungID == currentUserId);
}

<div class="col-lg-6 mx-auto" style="padding-top:60px">

    <div class="mb-3">
        <a href="javascript:history.back()" class="text-decoration-none text-muted fw-bold">
            <i class="fa-solid fa-arrow-left"></i> Quay lại
        </a>
    </div>

    <div class="card p-3 mb-4 shadow-sm border-0 post-card" data-baidangid="@Model.BaiDangID">

        <div class="d-flex align-items-center gap-2 mb-3">
            <img src="@anhAvatar" class="avatar rounded-circle" style="width:40px; height:40px; object-fit:cover;" />
            <div>
                <h6 class="m-0 fw-bold">@Model.NguoiDung.TenNguoiDung</h6>
                <small class="text-muted" style="font-size: 12px;">
                    @if ((DateTime.Now - (Model.NgayTao ?? DateTime.Now)).TotalHours < 24)
                    {
                        <span>@((int)(DateTime.Now - (Model.NgayTao ?? DateTime.Now)).TotalHours) giờ trước</span>
                    }
                    else
                    {
                        <span>@String.Format("{0:dd/MM/yyyy HH:mm}", Model.NgayTao)</span>
                    }
                </small>
            </div>
        </div>

        <p class="card-text mb-3">@Model.NoiDung</p>

        @if (!string.IsNullOrEmpty(Model.AnhUrl))
        {
            <div class="mb-3">
                <img src="@anhBaiViet" class="img-fluid rounded w-100" style="object-fit: contain; max-height: 600px;" />
            </div>
        }

        <div class="border-top border-bottom py-2 d-flex justify-content-between mt-2">
            <button class="btn btn-light flex-grow-1 btn-like @(daLike ? "text-primary" : "")" style="border:none;">
                <i class="@(daLike ? "fa-solid" : "fa-regular") fa-thumbs-up me-1"></i>
                Thích (<span class="like-count">@Model.ThichBaiDangs.Count()</span>)
            </button>

            <button class="btn btn-light flex-grow-1 btn-toggle-comment" style="border:none;">
                <i class="fa-regular fa-comment me-1"></i> Bình luận
            </button>
        </div>

        <div class="comment-section mt-3">

            <div class="comment-list mb-3">
                @if (Model.BinhLuans != null)
                {
                    foreach (var bl in Model.BinhLuans.OrderBy(b => b.NgayTao))
                    {
                        string blAvatar = "/Images/Avatar/" + (bl.NguoiDung.Avatar ?? "default.png");
                        <div class="d-flex mb-2 align-items-start">
                            <img src="@blAvatar" class="avatar rounded-circle me-2"
                                 style="width:26px; height:26px; object-fit:cover; flex-shrink: 0;" />

                            <div class="bg-light px-3 py-2 rounded-4">
                                <strong class="d-block text-dark" style="font-size: 13px;">@bl.NguoiDung.TenNguoiDung</strong>
                                <span class="text-secondary" style="font-size: 13px;">@bl.NoiDung</span>
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="d-flex gap-2 align-items-center">
                <img src="@currentAvatar" class="avatar rounded-circle"
                     style="width:26px; height:26px; object-fit:cover; flex-shrink: 0;" />

                <div class="position-relative w-100">
                    <input type="text" class="form-control rounded-pill bg-light comment-input py-1 px-3"
                           style="font-size: 14px;"
                           placeholder="Viết bình luận..."
                           data-id="@Model.BaiDangID">
                    <i class="fa-solid fa-paper-plane position-absolute top-50 end-0 translate-middle-y me-3 text-muted btn-send-comment"
                       style="cursor:pointer; font-size: 14px;"></i>
                </div>
            </div>
        </div>

    </div>
</div>

@section scripts {
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="/signalr/hubs"></script>
    <script>
        $(function () {
            // --- SIGNALR SETUP ---
            var hub = $.connection.hIOTFZone_BaiDangHub;

            // 1. Nhận Like realtime
            hub.client.updateLike = function (baiDangId, likeCount) {
                var post = $('.post-card[data-baidangid="' + baiDangId + '"]');
                post.find('.like-count').text(likeCount);
            };

            // 2. Nhận Comment realtime
            hub.client.addNewComment = function (baiDangId, tenUser, avatarUrl, noiDung) {
                var post = $('.post-card[data-baidangid="' + baiDangId + '"]');
                var commentList = post.find('.comment-list');

                // HTML khớp với server side (Avatar 26px)
                var newCommentHtml = `
                        <div class="d-flex mb-2 align-items-start">
                            <img src="${avatarUrl}" class="avatar rounded-circle me-2"
                                 style="width:26px; height:26px; object-fit:cover; flex-shrink: 0;">

                            <div class="bg-light px-3 py-2 rounded-4">
                                <strong class="d-block text-dark" style="font-size: 13px;">${tenUser}</strong>
                                <span class="text-secondary" style="font-size: 13px;">${noiDung}</span>
                            </div>
                        </div>
                    `;

                commentList.append(newCommentHtml);
            };

            $.connection.hub.start();


            // --- XỬ LÝ SỰ KIỆN ---

            // A. Toggle ẩn/hiện bình luận
            $(document).on('click', '.btn-toggle-comment', function () {
                var post = $(this).closest('.post-card');
                post.find('.comment-section').slideToggle();
                setTimeout(function () {
                    post.find('.comment-input').focus();
                }, 400);
            });

            // B. Gửi bình luận (Enter)
            $(document).on('keypress', '.comment-input', function (e) {
                if (e.which == 13) {
                    var input = $(this);
                    sendComment(input.data('id'), input.val(), input);
                }
            });

            // C. Gửi bình luận (Click icon)
            $(document).on('click', '.btn-send-comment', function () {
                var input = $(this).siblings('.comment-input');
                sendComment(input.data('id'), input.val(), input);
            });

            // Hàm gửi Ajax
            function sendComment(baiDangId, noiDung, inputElement) {
                if (!noiDung.trim()) return;

                $.ajax({
                    url: '/HIOTFZone_BaiViet/GuiBinhLuan',
                    type: 'POST',
                    data: { baiDangId: baiDangId, noiDung: noiDung },
                    success: function (res) {
                        if (res.success) {
                            inputElement.val('');
                        } else {
                            alert(res.message);
                        }
                    },
                    error: function () {
                        alert("Lỗi kết nối.");
                    }
                });
            }

            // D. Xử lý Like
            $(document).on('click', '.btn-like', function (e) {
                e.preventDefault();
                var btn = $(this);
                var postDiv = btn.closest('.post-card');
                var icon = btn.find('i');

                // Optimistic UI
                if (icon.hasClass('fa-regular')) {
                    icon.removeClass('fa-regular').addClass('fa-solid text-primary');
                    btn.addClass('text-primary');
                } else {
                    icon.removeClass('fa-solid text-primary').addClass('fa-regular');
                    btn.removeClass('text-primary');
                }

                $.post('/HIOTFZone_BaiViet/ToggleLike', { baiDangId: postDiv.data('baidangid') }, function (res) {
                    if (res.success) {
                        btn.find('.like-count').text(res.likeCount);
                        // Sync lại chính xác từ server
                        btn.find('i').toggleClass('fa-regular fa-solid text-primary', res.liked);
                        btn.find('i').toggleClass('fa-regular', !res.liked);
                    } else {
                        alert(res.message);
                    }
                });
            });
        });
    </script>
}